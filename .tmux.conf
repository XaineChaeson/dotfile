##### =========================================================
#####  Basic
##### =========================================================
set -g history-limit 200000
set -sg escape-time 10
setw -g mode-keys vi
set -g display-time 10000

# Reload config
bind-key -T prefix R source-file ~/.tmux.conf \; display-message "reloaded ~/.tmux.conf"


##### =========================================================
#####  Status bar: persistent mode hint (LEFT, append only)
##### =========================================================
set -g status-left-length 150
set -g status-left '#S #{?@mode,#[reverse] #{@mode}: #{@mode_hint} #[default],}'

##### =========================================================
#####  Mouse: default OFF for WindTerm drag-select
##### =========================================================
set -g mouse off

# Toggle mouse (prefix + m)
unbind-key -T prefix m
bind-key  -T prefix m run-shell 'tmux if-shell -F "#{mouse}" "set -g mouse off; display-message \"mouse: OFF (WindTerm drag-select)\"" "set -g mouse on; display-message \"mouse: ON (wheel scroll tmux panes)\""'


##### =========================================================
#####  Wheel scrolling: only when mouse=ON
##### =========================================================
bind-key -n WheelUpPane   if-shell -F '#{mouse}' 'copy-mode -e; send -M' ''
bind-key -n WheelDownPane if-shell -F '#{mouse}' 'send -M' ''


##### =========================================================
#####  Copy-mode (Vim style): copy to tmux buffer
##### =========================================================
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi V send -X select-line
bind-key -T copy-mode-vi y send -X copy-selection-and-cancel


##### =========================================================
#####  Pane zoom
##### =========================================================
bind-key -T prefix z resize-pane -Z


##### =========================================================
#####  Window layouts
#####  - prefix + g : enter layout table (then 1-5, q/Esc/Enter to exit)
#####  - prefix + G : popup menu
##### =========================================================
##### ===== Layout Mode (sticky) =====
unbind-key -T prefix g
bind-key -T prefix g set-option -g key-table layout \; set -g @mode "LAYOUT" \; set -g @mode_hint "1 even-h, 2 even-v, 3 main-h, 4 main-v, 5 tiled; q/Esc/Enter exit" \; display-message "[Layout] 1 even-h | 2 even-v | 3 main-h | 4 main-v | 5 tiled"

bind-key -T layout 1 select-layout even-horizontal
bind-key -T layout 2 select-layout even-vertical
bind-key -T layout 3 select-layout main-horizontal
bind-key -T layout 4 select-layout main-vertical
bind-key -T layout 5 select-layout tiled

bind-key -T layout q set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint \; display-message "LAYOUT: exit"
bind-key -T layout Escape set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint
bind-key -T layout Enter set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint

# Popup menu (doesn't need key-table)
bind-key -T prefix G display-menu -T "Select Layout" \
  "1 even-horizontal"   1 "select-layout even-horizontal" \
  "2 even-vertical"     2 "select-layout even-vertical" \
  "3 main-horizontal"   3 "select-layout main-horizontal" \
  "4 main-vertical"     4 "select-layout main-vertical" \
  "5 tiled (grid)"      5 "select-layout tiled"

##### =========================================================
#####  Resize Mode (client-only): prefix + r then h/j/k/l repeatedly
##### =========================================================
unbind-key -T prefix r
bind-key -T prefix r set-option -g key-table resize \; set -g @mode "RESIZE" \; set -g @mode_hint "h/j/k/l=1, H/J/K/L=5; q/Esc/Enter exit" \; display-message "RESIZE MODE"

bind-key -T resize h resize-pane -L 1
bind-key -T resize j resize-pane -D 1
bind-key -T resize k resize-pane -U 1
bind-key -T resize l resize-pane -R 1

bind-key -T resize H resize-pane -L 5
bind-key -T resize J resize-pane -D 5
bind-key -T resize K resize-pane -U 5
bind-key -T resize L resize-pane -R 5

bind-key -T resize q set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint \; display-message "RESIZE MODE: exit"
bind-key -T resize Escape set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint
bind-key -T resize Enter set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint

##### =========================================================
#####  PANE MODE (sticky, global key-table; consistent with your other modes)
#####  - Single-shot: prefix + h/j/k/l
#####  - Enter mode : prefix + p
#####  - In mode    : h/j/k/l switch
#####                v / b  split (right / down, keep cwd)
#####                m      toggle mark (multi, per-pane @pmarked)
#####                x      kill ALL marked panes (CURRENT WINDOW only, batch-safe)
#####                C      clear ALL marks (CURRENT WINDOW only, batch-safe)
#####                s      enter SWAP sub-mode
#####                q/Esc/Enter exit
##### =========================================================

##### ----- Visual mark indicator: red dot + pane index -----
set -g pane-border-status top
set -g pane-border-format "#{?#{==:#{pane_option:@pmarked},1},#[fg=red]●#P#[default] ,}#P #{pane_title}"
set -g pane-active-border-style "fg=brightcyan"
set -g pane-border-style "fg=brightblack"

##### ----- Single-shot pane select (keep) -----
unbind-key -T prefix h
unbind-key -T prefix j
unbind-key -T prefix k
unbind-key -T prefix l
bind-key   -T prefix h select-pane -L
bind-key   -T prefix j select-pane -D
bind-key   -T prefix k select-pane -U
bind-key   -T prefix l select-pane -R

##### ----- Enter Pane Mode -----
unbind-key -T prefix p
bind-key -T prefix p set-option -g key-table pane \; \
  set -g @mode "PANE" \; \
  set -g @mode_hint "h/j/k/l switch | v/b split | m mark | x kill(win) | C clear(win) | s swap | q/Esc/Enter exit" \; \
  display-message "PANE MODE"

##### ----- Pane Mode: move -----
bind-key -T pane h select-pane -L
bind-key -T pane j select-pane -D
bind-key -T pane k select-pane -U
bind-key -T pane l select-pane -R

##### ----- Pane Mode: new panes (keep cwd) -----
bind-key -T pane v split-window -h -c "#{pane_current_path}"
bind-key -T pane b split-window    -c "#{pane_current_path}"

##### ----- Pane Mode: toggle mark -----
bind-key -T pane m if-shell -F "#{==:#{pane_option:@pmarked},1}" \
  "set-option -p -u @pmarked \; display-message 'MARK OFF ●#P  id=#{pane_id}'" \
  "set-option -p @pmarked 1 \; display-message 'MARK ON  ●#P  id=#{pane_id}'"

##### ----- Pane Mode: kill marked panes (CURRENT WINDOW only, snapshot first) -----
# Kill ALL marked panes in CURRENT WINDOW
bind-key -T pane x run-shell ' \
  win=$(tmux display-message -p "#{window_id}"); \
  ids=$(tmux list-panes -t "$win" -F "##{pane_id} ##{pane_option:@pmarked}" | grep " 1$" | cut -d" " -f1); \
  if [ -z "$ids" ]; then \
    tmux display-message "No marked panes in this window"; \
  else \
    for id in $ids; do \
      tmux kill-pane -t "$id" 2>/dev/null; \
    done; \
    count=$(printf "%s\n" "$ids" | wc -l | tr -d " "); \
    tmux display-message "Killed marked panes (this window): $count"; \
  fi \
'

# Clear ALL marks in CURRENT WINDOW
bind-key -T pane C run-shell ' \
  win=$(tmux display-message -p "#{window_id}"); \
  ids=$(tmux list-panes -t "$win" -F "##{pane_id} ##{pane_option:@pmarked}" | grep " 1$" | cut -d" " -f1); \
  if [ -z "$ids" ]; then \
    tmux display-message "No marks to clear in this window"; \
  else \
    for id in $ids; do \
      tmux set-option -p -t "$id" -u @pmarked 2>/dev/null; \
    done; \
    count=$(printf "%s\n" "$ids" | wc -l | tr -d " "); \
    tmux display-message "Cleared marks (this window): $count"; \
  fi \
'


##### ----- Pane Mode: SWAP sub-mode -----
#####  - Uses {left/right/up/down-of} targets for swap
#####  - Moves focus with the carried pane

# Enter swap mode
bind-key -T pane s set-option -g key-table pane-swap \; \
  set -g @mode "SWAP" \; \
  set -g @mode_hint "h/j/k/l swap-with-neighbor | q/Esc/Enter back" \; \
  display-message "SWAP MODE"

# Left: swap with left neighbor, keep focus on the carried pane
bind-key -T pane-swap h if-shell -F '#{pane_at_left}' \
  'display-message "SWAP: no pane left"' \
  'swap-pane -t "{left-of}"; select-pane -t "{left-of}"'

# Right
bind-key -T pane-swap l if-shell -F '#{pane_at_right}' \
  'display-message "SWAP: no pane right"' \
  'swap-pane -t "{right-of}"; select-pane -t "{right-of}"'

# Up
bind-key -T pane-swap k if-shell -F '#{pane_at_top}' \
  'display-message "SWAP: no pane up"' \
  'swap-pane -t "{up-of}"; select-pane -t "{up-of}"'

# Down
bind-key -T pane-swap j if-shell -F '#{pane_at_bottom}' \
  'display-message "SWAP: no pane down"' \
  'swap-pane -t "{down-of}"; select-pane -t "{down-of}"'


# Exit swap back to Pane Mode
bind-key -T pane-swap q      set-option -g key-table pane \; set -g @mode "PANE" \; set -g @mode_hint "h/j/k/l switch | v/b split | m mark | x kill(win) | C clear(win) | s swap | q/Esc/Enter exit" \; display-message "SWAP → PANE"
bind-key -T pane-swap Escape set-option -g key-table pane \; set -g @mode "PANE" \; set -g @mode_hint "h/j/k/l switch | v/b split | m mark | x kill(win) | C clear(win) | s swap | q/Esc/Enter exit"
bind-key -T pane-swap Enter  set-option -g key-table pane \; set -g @mode "PANE" \; set -g @mode_hint "h/j/k/l switch | v/b split | m mark | x kill(win) | C clear(win) | s swap | q/Esc/Enter exit"


##### ----- Exit Pane Mode -----
bind-key -T pane q      set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint \; display-message "PANE MODE: exit"
bind-key -T pane Escape set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint
bind-key -T pane Enter  set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint
