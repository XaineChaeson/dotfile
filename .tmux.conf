##### =========================================================
#####  Basic
##### =========================================================
set -g history-limit 200000
set -sg escape-time 0
setw -g mode-keys vi
set -g display-time 10000

# Reload config
bind-key -T prefix R source-file ~/.tmux.conf \; display-message "reloaded ~/.tmux.conf"


##### =========================================================
#####  Status bar: persistent mode hint (LEFT, append only)
##### =========================================================
#set -ga status-left ' #{?@mode,#[reverse] #{@mode}: #{@mode_hint} #[default],}'
set -g status-left-length 150
set -g status-left '#S #{?@mode,#[reverse] #{@mode}: #{@mode_hint} #[default],}'

##### =========================================================
#####  Mouse: default OFF for WindTerm drag-select
##### =========================================================
set -g mouse off

# Toggle mouse (prefix + m)
unbind-key -T prefix m
bind-key  -T prefix m run-shell 'tmux if-shell -F "#{mouse}" "set -g mouse off; display-message \"mouse: OFF (WindTerm drag-select)\"" "set -g mouse on; display-message \"mouse: ON (wheel scroll tmux panes)\""'


##### =========================================================
#####  Wheel scrolling: only when mouse=ON
##### =========================================================
bind-key -n WheelUpPane   if-shell -F '#{mouse}' 'copy-mode -e; send -M' ''
bind-key -n WheelDownPane if-shell -F '#{mouse}' 'send -M' ''


##### =========================================================
#####  Copy-mode (Vim style): copy to tmux buffer
##### =========================================================
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi V send -X select-line
bind-key -T copy-mode-vi y send -X copy-selection-and-cancel


##### =========================================================
#####  Pane zoom
##### =========================================================
bind-key -T prefix z resize-pane -Z


##### =========================================================
#####  Window layouts
#####  - prefix + g : enter layout table (then 1-5, q/Esc/Enter to exit)
#####  - prefix + G : popup menu
##### =========================================================
##### ===== Layout Mode (sticky) =====
unbind-key -T prefix g
bind-key -T prefix g set-option -g key-table layout \; set -g @mode "LAYOUT" \; set -g @mode_hint "1 even-h, 2 even-v, 3 main-h, 4 main-v, 5 tiled; q/Esc/Enter exit" \; display-message "[Layout] 1 even-h | 2 even-v | 3 main-h | 4 main-v | 5 tiled"

bind-key -T layout 1 select-layout even-horizontal
bind-key -T layout 2 select-layout even-vertical
bind-key -T layout 3 select-layout main-horizontal
bind-key -T layout 4 select-layout main-vertical
bind-key -T layout 5 select-layout tiled

bind-key -T layout q set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint \; display-message "LAYOUT: exit"
bind-key -T layout Escape set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint
bind-key -T layout Enter set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint

# Popup menu (doesn't need key-table)
bind-key -T prefix G display-menu -T "Select Layout" \
  "1 even-horizontal"   1 "select-layout even-horizontal" \
  "2 even-vertical"     2 "select-layout even-vertical" \
  "3 main-horizontal"   3 "select-layout main-horizontal" \
  "4 main-vertical"     4 "select-layout main-vertical" \
  "5 tiled (grid)"      5 "select-layout tiled"


##### =========================================================
#####  Pane switching: keep BOTH
#####  - Single-shot: prefix + h/j/k/l
#####  - Pane Mode (client-only): prefix + p then h/j/k/l repeatedly
##### =========================================================

# Single-shot pane select
unbind-key -T prefix h
unbind-key -T prefix j
unbind-key -T prefix k
unbind-key -T prefix l
bind-key   -T prefix h select-pane -L
bind-key   -T prefix j select-pane -D
bind-key   -T prefix k select-pane -U
bind-key   -T prefix l select-pane -R

# Pane Mode (client-only)
unbind-key -T prefix p
bind-key -T prefix p set-option -g key-table pane \; set -g @mode "PANE" \; set -g @mode_hint "h/j/k/l switch; q/Esc/Enter exit" \; display-message "PANE MODE"

bind-key -T pane h select-pane -L
bind-key -T pane j select-pane -D
bind-key -T pane k select-pane -U
bind-key -T pane l select-pane -R

bind-key -T pane q set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint \; display-message "PANE MODE: exit"
bind-key -T pane Escape set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint
bind-key -T pane Enter set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint


##### =========================================================
#####  Resize Mode (client-only): prefix + r then h/j/k/l repeatedly
##### =========================================================
unbind-key -T prefix r
bind-key -T prefix r set-option -g key-table resize \; set -g @mode "RESIZE" \; set -g @mode_hint "h/j/k/l=1, H/J/K/L=5; q/Esc/Enter exit" \; display-message "RESIZE MODE"

bind-key -T resize h resize-pane -L 1
bind-key -T resize j resize-pane -D 1
bind-key -T resize k resize-pane -U 1
bind-key -T resize l resize-pane -R 1

bind-key -T resize H resize-pane -L 5
bind-key -T resize J resize-pane -D 5
bind-key -T resize K resize-pane -U 5
bind-key -T resize L resize-pane -R 5

bind-key -T resize q set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint \; display-message "RESIZE MODE: exit"
bind-key -T resize Escape set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint
bind-key -T resize Enter set-option -g key-table root \; set -gu @mode \; set -gu @mode_hint

